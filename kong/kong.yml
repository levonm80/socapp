_format_version: "3.0"
_transform: true

services:
  - name: backend-service
    url: http://api:5000
    routes:
      - name: auth-login-route
        paths:
          - /api/auth/login
        methods:
          - POST
          - OPTIONS
        strip_path: false
        plugins:
          - name: cors
            config:
              origins:
                - http://localhost:3000
                - http://127.0.0.1:3000
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - OPTIONS
                - PATCH
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-User-Id
                - X-Requested-With
              exposed_headers:
                - X-User-Id
                - Content-Type
              credentials: true
              max_age: 3600
              preflight_continue: false
      
      - name: protected-routes
        paths:
          - /api/logs
          - /api/dashboard
          - /api/anomalies
          - /api/ai
          - /api/auth/logout
          - /api/auth/me
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        strip_path: false
        plugins:
          - name: jwt
            config:
              secret_is_base64: false
              claims_to_verify:
                - exp
              header_names:
                - Authorization
              uri_param_names: []
              anonymous: null
              run_on_preflight: false
          - name: cors
            config:
              origins:
                - http://localhost:3000
                - http://127.0.0.1:3000
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - OPTIONS
                - PATCH
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-User-Id
                - X-Requested-With
              exposed_headers:
                - X-User-Id
                - Content-Type
              credentials: true
              max_age: 3600
              preflight_continue: false

consumers:
  - username: default-jwt-consumer
    jwt_secrets:
      - key: flask-jwt
        algorithm: HS256
        # IMPORTANT: Replace this secret with your actual JWT_SECRET_KEY value
        # Kong doesn't support environment variable substitution in YAML files
        # This secret MUST match the JWT_SECRET_KEY in your .env file
        secret: change-me-in-production-must-match-JWT_SECRET_KEY
        rsa_public_key: null

